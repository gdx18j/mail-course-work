name: Mail Platform CI/CD Pipeline

on:
  push:
    branches:
      - main
      - dev

env:
  STACK_NAME: mailcourse

jobs:
  ci:
    name: Build and Test Mail Platform
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install Docker Compose
        run: |
          sudo curl -SL https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m) -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
          docker-compose --version

      - name: Create test configuration with SSL
        run: |
          mkdir -p dms-config/ssl
          echo "# Test configuration for CI" > dms-config/config.env
          echo "ENABLE_FAIL2BAN=0" >> dms-config/config.env
          echo "ENABLE_RSPAMD=0" >> dms-config/config.env
          
          openssl req -new -x509 -days 3650 -nodes \
            -out dms-config/ssl/mail.ci.local-cert.pem \
            -keyout dms-config/ssl/mail.ci.local-key.pem \
            -subj "/C=RU/ST=Moscow/L=Moscow/O=Course/CN=mail.ci.local"

      - name: Create simplified docker-compose.ci.yml
        run: |
          echo "services:" > docker-compose.ci.yml
          echo "  db:" >> docker-compose.ci.yml
          echo "    image: postgres:16-alpine" >> docker-compose.ci.yml
          echo "    container_name: mail-db-ci" >> docker-compose.ci.yml
          echo "    environment:" >> docker-compose.ci.yml
          echo "      POSTGRES_DB: maildb" >> docker-compose.ci.yml
          echo "      POSTGRES_USER: mailuser" >> docker-compose.ci.yml
          echo "      POSTGRES_PASSWORD: password" >> docker-compose.ci.yml
          echo "    healthcheck:" >> docker-compose.ci.yml
          echo "      test: [\"CMD-SHELL\", \"pg_isready -U mailuser -d maildb\"]" >> docker-compose.ci.yml
          echo "      interval: 10s" >> docker-compose.ci.yml
          echo "      timeout: 5s" >> docker-compose.ci.yml
          echo "      retries: 5" >> docker-compose.ci.yml
          echo "    networks:" >> docker-compose.ci.yml
          echo "      - mailnet" >> docker-compose.ci.yml
          echo "" >> docker-compose.ci.yml
          echo "  mailserver:" >> docker-compose.ci.yml
          echo "    image: ghcr.io/docker-mailserver/docker-mailserver:latest" >> docker-compose.ci.yml
          echo "    container_name: mail-server-ci" >> docker-compose.ci.yml
          echo "    hostname: mail.ci.local" >> docker-compose.ci.yml
          echo "    domainname: ci.local" >> docker-compose.ci.yml
          echo "    environment:" >> docker-compose.ci.yml
          echo "      SSL_TYPE: self-signed" >> docker-compose.ci.yml
          echo "      ONE_DIR: 1" >> docker-compose.ci.yml
          echo "      PERMIT_DOCKER: network" >> docker-compose.ci.yml
          echo "      POSTMASTER_ADDRESS: postmaster@ci.local" >> docker-compose.ci.yml
          echo "      SMTP_ONLY: 0" >> docker-compose.ci.yml
          echo "      ENABLE_FAIL2BAN: 0" >> docker-compose.ci.yml
          echo "      ENABLE_RSPAMD: 0" >> docker-compose.ci.yml
          echo "    ports:" >> docker-compose.ci.yml
          echo "      - \"1025:25\"" >> docker-compose.ci.yml
          echo "      - \"1587:587\"" >> docker-compose.ci.yml
          echo "      - \"1993:993\"" >> docker-compose.ci.yml
          echo "    volumes:" >> docker-compose.ci.yml
          echo "      - ./dms-config:/tmp/docker-mailserver" >> docker-compose.ci.yml
          echo "    depends_on:" >> docker-compose.ci.yml
          echo "      db:" >> docker-compose.ci.yml
          echo "        condition: service_healthy" >> docker-compose.ci.yml
          echo "    networks:" >> docker-compose.ci.yml
          echo "      - mailnet" >> docker-compose.ci.yml
          echo "" >> docker-compose.ci.yml
          echo "  pgadmin:" >> docker-compose.ci.yml
          echo "    image: dpage/pgadmin4:latest" >> docker-compose.ci.yml
          echo "    container_name: pgadmin-ci" >> docker-compose.ci.yml
          echo "    environment:" >> docker-compose.ci.yml
          echo "      PGADMIN_DEFAULT_EMAIL: admin@example.com" >> docker-compose.ci.yml
          echo "      PGADMIN_DEFAULT_PASSWORD: admin" >> docker-compose.ci.yml
          echo "    ports:" >> docker-compose.ci.yml
          echo "      - \"18080:80\"" >> docker-compose.ci.yml
          echo "    depends_on:" >> docker-compose.ci.yml
          echo "      - db" >> docker-compose.ci.yml
          echo "    networks:" >> docker-compose.ci.yml
          echo "      - mailnet" >> docker-compose.ci.yml
          echo "" >> docker-compose.ci.yml
          echo "networks:" >> docker-compose.ci.yml
          echo "  mailnet:" >> docker-compose.ci.yml
          echo "    driver: bridge" >> docker-compose.ci.yml

      - name: Validate docker-compose.ci.yml
        run: |
          echo "Validating YAML syntax..."
          docker-compose -f docker-compose.ci.yml config
          echo "Configuration is valid"

      - name: Start core services
        run: |
          docker-compose -f docker-compose.ci.yml up -d
          echo "Services started"
          docker-compose -f docker-compose.ci.yml ps

      - name: Wait and check services
        run: |
          echo "Waiting for services to start..."
          sleep 30
          
          echo "Checking database..."
          for i in {1..10}; do
            if docker-compose -f docker-compose.ci.yml exec db pg_isready -U mailuser -d maildb; then
              echo "Database is ready"
              break
            fi
            echo "Waiting for database... ($i/10)"
            sleep 5
          done
          
          echo "Checking mail server SSL..."
          if docker-compose -f docker-compose.ci.yml logs mailserver | grep -q "TLS Setup"; then
            echo "Mail server SSL check passed"
          else
            echo "Warning: Mail server SSL logs not found"
          fi

      - name: Health check
        run: |
          echo "HEALTH CHECK"
          
          echo "Checking core services..."
          if docker-compose -f docker-compose.ci.yml ps db | grep -q "Up"; then
            echo "Database is running"
          else
            echo "Database is not running"
            exit 1
          fi
          
          if docker-compose -f docker-compose.ci.yml ps mailserver | grep -q "Up"; then
            echo "Mail server is running"
          else
            echo "Mail server is not running"
            docker-compose -f docker-compose.ci.yml logs mailserver --tail=20
          fi
          
          if docker-compose -f docker-compose.ci.yml ps pgadmin | grep -q "Up"; then
            echo "pgAdmin is running"
          else
            echo "pgAdmin is not running"
          fi
          
          echo ""
          echo "PORT CHECK"
          for port in 1025 1587 18080; do
            if timeout 2 bash -c "echo > /dev/tcp/127.0.0.1/$port" 2>/dev/null; then
              echo "Port $port is listening"
            else
              echo "Port $port not listening"
            fi
          done
          
          echo ""
          echo "SUMMARY: Core services validated"

      - name: Cleanup
        if: always()
        run: |
          echo "Cleaning up..."
          docker-compose -f docker-compose.ci.yml down -v
          echo "Cleanup completed"
          echo "Cleaning up..."
          docker-compose -f docker-compose.ci.yml down -v
          echo "Cleanup completed"
