name: Mail Platform CI/CD Pipeline

on:
  push:
    branches:
      - main
      - dev

env:
  STACK_NAME: mailcourse

jobs:
  ci:
    name: Build and Test Mail Platform
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install Docker Compose
        run: |
          sudo curl -SL https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m) -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
          docker-compose --version

      - name: Create test configuration
        run: |
          mkdir -p dms-config/ssl
          echo "# Test configuration for CI" > dms-config/config.env
          echo "ENABLE_FAIL2BAN=0" >> dms-config/config.env
          echo "ENABLE_RSPAMD=0" >> dms-config/config.env

      - name: Create docker-compose.ci.yml
        run: |
          # Создаем файл через echo с правильным форматированием
          echo "version: '3.8'" > docker-compose.ci.yml
          echo "" >> docker-compose.ci.yml
          echo "services:" >> docker-compose.ci.yml
          echo "  db:" >> docker-compose.ci.yml
          echo "    image: postgres:16-alpine" >> docker-compose.ci.yml
          echo "    container_name: mail-db-ci" >> docker-compose.ci.yml
          echo "    environment:" >> docker-compose.ci.yml
          echo "      POSTGRES_DB: maildb" >> docker-compose.ci.yml
          echo "      POSTGRES_USER: mailuser" >> docker-compose.ci.yml
          echo "      POSTGRES_PASSWORD: password" >> docker-compose.ci.yml
          echo "    healthcheck:" >> docker-compose.ci.yml
          echo "      test: [\"CMD-SHELL\", \"pg_isready -U mailuser -d maildb\"]" >> docker-compose.ci.yml
          echo "      interval: 10s" >> docker-compose.ci.yml
          echo "      timeout: 5s" >> docker-compose.ci.yml
          echo "      retries: 5" >> docker-compose.ci.yml
          echo "    networks:" >> docker-compose.ci.yml
          echo "      - mailnet" >> docker-compose.ci.yml
          echo "" >> docker-compose.ci.yml
          echo "  mailserver:" >> docker-compose.ci.yml
          echo "    image: ghcr.io/docker-mailserver/docker-mailserver:latest" >> docker-compose.ci.yml
          echo "    container_name: mail-server-ci" >> docker-compose.ci.yml
          echo "    hostname: mail.ci.local" >> docker-compose.ci.yml
          echo "    domainname: ci.local" >> docker-compose.ci.yml
          echo "    environment:" >> docker-compose.ci.yml
          echo "      SSL_TYPE: self-signed" >> docker-compose.ci.yml
          echo "      ONE_DIR: 1" >> docker-compose.ci.yml
          echo "      PERMIT_DOCKER: network" >> docker-compose.ci.yml
          echo "      POSTMASTER_ADDRESS: postmaster@ci.local" >> docker-compose.ci.yml
          echo "      SMTP_ONLY: 0" >> docker-compose.ci.yml
          echo "    ports:" >> docker-compose.ci.yml
          echo "      - \"1025:25\"" >> docker-compose.ci.yml
          echo "      - \"1587:587\"" >> docker-compose.ci.yml
          echo "      - \"1993:993\"" >> docker-compose.ci.yml
          echo "    volumes:" >> docker-compose.ci.yml
          echo "      - ./dms-config:/tmp/docker-mailserver" >> docker-compose.ci.yml
          echo "    depends_on:" >> docker-compose.ci.yml
          echo "      db:" >> docker-compose.ci.yml
          echo "        condition: service_healthy" >> docker-compose.ci.yml
          echo "    networks:" >> docker-compose.ci.yml
          echo "      - mailnet" >> docker-compose.ci.yml
          echo "" >> docker-compose.ci.yml
          echo "  pgadmin:" >> docker-compose.ci.yml
          echo "    image: dpage/pgadmin4:latest" >> docker-compose.ci.yml
          echo "    container_name: pgadmin-ci" >> docker-compose.ci.yml
          echo "    environment:" >> docker-compose.ci.yml
          echo "      PGADMIN_DEFAULT_EMAIL: admin@ci.local" >> docker-compose.ci.yml
          echo "      PGADMIN_DEFAULT_PASSWORD: admin" >> docker-compose.ci.yml
          echo "    ports:" >> docker-compose.ci.yml
          echo "      - \"18080:80\"" >> docker-compose.ci.yml
          echo "    depends_on:" >> docker-compose.ci.yml
          echo "      - db" >> docker-compose.ci.yml
          echo "    networks:" >> docker-compose.ci.yml
          echo "      - mailnet" >> docker-compose.ci.yml
          echo "" >> docker-compose.ci.yml
          echo "  rainloop:" >> docker-compose.ci.yml
          echo "    image: hardware/rainloop:latest" >> docker-compose.ci.yml
          echo "    container_name: rainloop-ci" >> docker-compose.ci.yml
          echo "    ports:" >> docker-compose.ci.yml
          echo "      - \"18888:8888\"" >> docker-compose.ci.yml
          echo "    environment:" >> docker-compose.ci.yml
          echo "      - APACHE_HTTP_PORT=80" >> docker-compose.ci.yml
          echo "    depends_on:" >> docker-compose.ci.yml
          echo "      - mailserver" >> docker-compose.ci.yml
          echo "    networks:" >> docker-compose.ci.yml
          echo "      - mailnet" >> docker-compose.ci.yml
          echo "" >> docker-compose.ci.yml
          echo "  portainer:" >> docker-compose.ci.yml
          echo "    image: portainer/portainer-ce:latest" >> docker-compose.ci.yml
          echo "    container_name: portainer-ci" >> docker-compose.ci.yml
          echo "    ports:" >> docker-compose.ci.yml
          echo "      - \"19000:9000\"" >> docker-compose.ci.yml
          echo "    volumes:" >> docker-compose.ci.yml
          echo "      - portainer_data:/data" >> docker-compose.ci.yml
          echo "    command: -H unix:///var/run/docker.sock --http-enabled" >> docker-compose.ci.yml
          echo "    networks:" >> docker-compose.ci.yml
          echo "      - mailnet" >> docker-compose.ci.yml
          echo "" >> docker-compose.ci.yml
          echo "networks:" >> docker-compose.ci.yml
          echo "  mailnet:" >> docker-compose.ci.yml
          echo "    driver: bridge" >> docker-compose.ci.yml
          echo "" >> docker-compose.ci.yml
          echo "volumes:" >> docker-compose.ci.yml
          echo "  portainer_data:" >> docker-compose.ci.yml

          echo "Created docker-compose.ci.yml"

      - name: Validate docker-compose.ci.yml
        run: |
          echo "Validating YAML syntax..."
          docker-compose -f docker-compose.ci.yml config
          echo "Configuration is valid"

      - name: Start mail services
        run: |
          docker-compose -f docker-compose.ci.yml up -d
          echo "Services started"
          docker-compose -f docker-compose.ci.yml ps

      - name: Wait for services
        run: |
          echo "Waiting for services to start..."
          sleep 20
          
          echo "Checking database..."
          for i in {1..10}; do
            if docker-compose -f docker-compose.ci.yml exec db pg_isready -U mailuser -d maildb; then
              echo "Database is ready"
              break
            fi
            echo "Waiting for database... ($i/10)"
            sleep 5
          done

      - name: Health check
        run: |
          echo "HEALTH CHECK"
          
          RUNNING=$(docker-compose -f docker-compose.ci.yml ps --services --filter "status=running" | wc -l)
          echo "Running containers: $RUNNING/5"
          
          if [ $RUNNING -ge 3 ]; then
            echo "Core services are running"
          else
            echo "Some services failed to start"
            docker-compose -f docker-compose.ci.yml logs --tail=50
            exit 1
          fi
          
          echo ""
          echo "PORT CHECK"
          for port in 1025 1587 1993 18080 18888 19000; do
            if timeout 2 bash -c "echo > /dev/tcp/127.0.0.1/$port" 2>/dev/null; then
              echo "Port $port is listening"
            else
              echo "Port $port not listening (might be OK for CI)"
            fi
          done

      - name: Test basic functionality
        run: |
          echo "BASIC TESTS"
          
          echo "Testing PostgreSQL..."
          if docker-compose -f docker-compose.ci.yml exec -T db psql -U mailuser -d maildb -c "SELECT 1;" > /dev/null 2>&1; then
            echo "PostgreSQL is working"
          else
            echo "PostgreSQL test failed"
          fi
          
          echo ""
          echo "Container status:"
          docker-compose -f docker-compose.ci.yml ps -a

      - name: Cleanup
        if: always()
        run: |
          echo "Cleaning up..."
          docker-compose -f docker-compose.ci.yml down -v
          echo "Cleanup completed"

  generate-deploy-guide:
    name: Generate Deployment Guide
    needs: ci
    runs-on: ubuntu-latest
    if: success()
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
