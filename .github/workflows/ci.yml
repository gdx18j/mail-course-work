name: CI/CD for Mail Platform

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  validate-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Check required files
        run: |
          echo "Проверяем наличие необходимых файлов:"
          ls -la
          echo "---"
          if [ ! -f "swarm.yml" ]; then
            echo "Ошибка: файл swarm.yml не найден!"
            exit 1
          fi
          echo "Файл swarm.yml найден"
          
      - name: Validate Docker Compose structure
        run: |
          echo "Проверяем структуру Docker Compose..."
          # Проверяем наличие обязательных секций
          python3 -c "
          import yaml
          with open('swarm.yml', 'r') as f:
              data = yaml.safe_load(f)
          
          required_sections = ['services', 'volumes', 'networks']
          missing = [s for s in required_sections if s not in data]
          
          if missing:
              print(f' Отсутствуют секции: {missing}')
              exit(1)
          
          print(' Все обязательные секции присутствуют:')
          print(f'   - Сервисы: {len(data.get(\"services\", {}))} шт.')
          print(f'   - Тома: {len(data.get(\"volumes\", {}))} шт.')
          print(f'   - Сети: {len(data.get(\"networks\", {}))} шт.')
          "
          
      # 5. Показать информацию о сервисах (для отладки)
      - name: Show services info
        run: |
          echo "Информация о сервисах в swarm.yml:"
          python3 -c "
          import yaml
          with open('swarm.yml', 'r') as f:
              data = yaml.safe_load(f)
          
          services = data.get('services', {})
          print(f'Всего сервисов: {len(services)}')
          print('---')
          for service_name, service_config in services.items():
              image = service_config.get('image', 'не указан')
              ports = service_config.get('ports', [])
              print(f'  {service_name}:')
              print(f'   Образ: {image}')
              if ports:
                  print(f'   Публичные порты: {ports}')
              print()
          "
        
            
      # 7. Запасной шаг - показать команды для ручного деплоя
      - name: Manual deployment instructions
        if: ${{ true }}  # Всегда показываем
        run: |
          echo "================================================"
          echo "ИНСТРУКЦИЯ ДЛЯ РУЧНОГО РАЗВЁРТЫВАНИЯ:"
          echo "================================================"
          echo ""
          echo "1. Скопируйте swarm.yml на сервер:"
          echo "   scp swarm.yml user@ваш-сервер:/opt/mail-course/"
          echo ""
          echo "2. Подключитесь к серверу по SSH:"
          echo "   ssh user@ваш-сервер"
          echo ""
          echo "3. Перейдите в директорию проекта:"
          echo "   cd /opt/mail-course"
          echo ""
          echo "4. Инициализируйте Docker Swarm (если ещё не сделано):"
          echo "   docker swarm init"
          echo ""
          echo "5. Разверните стек:"
          echo "   docker stack deploy -c swarm.yml mailcourse"
          echo ""
          echo "6. Проверьте статус:"
          echo "   docker stack services mailcourse"
